---
title: "Analyze Protein Categories"
subtitle: ""
author: "[Benjamin Dubreuil](https://github.com/benjamin-elusers/)"
home: "https://github.com/benjamin-elusers/yeastomics/"
github: "benjamin-elusers"
mail: "benjamin.dubreuil@weizmann.ac.il"
date: "`r format(Sys.time(), 'Last Modified: %d-%b-%Y %R %p')`"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: true
    highlight: tango
#  html_document: 
    code_download: true
    code_folding: hide
    fig_caption: yes
    keep_md: yes
#    toc: yes
    toc_depth: 3
    toc_float:
      toc_collapsed: true
    number_sections: true
    theme: lumen
  editor_options: 
    chunk_output_type: console
  bibliography: bibliography.bib
  csl: biomed-central.csl
---
<!-- Github Logo -->
<a href="https://github.com/benjamin-elusers/yeastomics/" class="github-corner" aria-label="View source on Github">
  <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#69b3a2; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
  </svg>
</a>

<style> 
.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}
@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}
@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      collapse = TRUE,
                      cache.lazy = FALSE,
                      autodep = TRUE,
                      warning = FALSE)
if('utils' %in% search()){ detach('utils') }
utils = attach(NULL,name = 'utils')
if('funcs' %in% search()){ detach('funcs') }
funcs = attach(NULL,name = 'funcs')

suppressPackageStartupMessages({
  library(tictoc)
  library(tidyverse)
  library(stringr)
  library(hablar)
  
  
  source("src/utils.r")
  source("src/function_annotation.r")
  source("src/function_sequence.r")
  source("src/function_phylogenetic.r")
  source("src/function_analysis.r")
  source("src/function_datalocal.r")
  source("src/function_datapub.r")
})

# turn off annoying messages from dplyr::summarise
options(dplyr.summarise.inform = FALSE)
```

# Evolutionary dataset

```{r evodata}
## CROSS-REFERENCE PROTEOME ----------------------------------------------------
PROTEOME = UNIPROT %>% dplyr::select(UNIPROTKB, SGD, ORF, GNAME, PNAME)

# EVOLUTIONARY RATE
ER = load.dubreuil2021.data(1) %>% 
     as_tibble() %>%
     dplyr::select(c(starts_with('EVO.'),'PPM','ORF','UNIPROT')) %>%
     hablar::convert(dbl(EVO.FULL), dbl(PPM))

```

# Protein categories

## Loading precomputed data

```{r protcat}
# protein properties (qualitative)
PROP=readRDS(get.last.file("data","proteome-properties"))
PROP_lgl = PROP %>% ungroup() %>% dplyr::select( where(is.logical) )
# protein features (quantitative)
FEAT=readRDS(get.last.file("data","proteome-features"))
FEAT_num = FEAT %>% ungroup() %>% dplyr::select( where(is.numeric) )

TOT_PROP=ncol(PROP_lgl)
TOT_FEAT=ncol(FEAT_num)
```


There are a total of **`r TOT_PROP`** proteome properties and **`r TOT_FEAT`**
They are organized into 

**`r kable(TOTAL_CATEGORIES)`** 

We also gathered **`r TOTAL_FEATURES`** protein features.
## Compute properties similarities

```{r properties}
library(proxy)
# similarity between properties
PROP_cor = cor(PROP_lgl, use = 'pairwise.complete',method = 'spearman') 
#PROP_jac = dist(PROP_lgl, use = 'pairwise.complete',method = 'spearman') 

pheatmap::pheatmap(PROP_jac,
                   show_colnames = F, show_rownames = T,
                   cluster_cols = T, cluster_rows = T,
                   cellheight=5, cellwidth=5,fontsize=6,border_color = NA,
                   filename = "plots/properties-overlap.pdf", height=50, width=50)
```



## Residual evolutionary rate
```{r fit-ER}
# Fitting mean Evolutionary rate (eR) to Protein abundance (pA)
init.params =  list(Asym = 3, xmid = 1.5, scal=-1)
nls.fit = nls(EVO.FULL ~ SSlogis(PPM,Asym,xmid,scal),start=init.params,data = ER )
fit.ER = broom::augment_columns(x = nls.fit, data = ER) %>% 
           ungroup() %>% 
           mutate(SSE = sum(.resid^2), total.resid = sum(.resid),
                  avg.resid = mean_(.resid), 
                  neg.resid = sum(.resid[.resid<0]),
                  pos.resid = sum(.resid[.resid>0])) %>%   
          left_join(PROT,by=c('UNIPROT'='UNIPROTKB','ORF'='ORF'))

# Show the residuals of the eR~pA fit 
library(ggplot2)
library(ggthemes)
MR = ggplot(fit.ER, aes(y = EVO.FULL, x = PPM)) +
     geom_abline(slope=0,intercept = mean(fit.ER$EVO.FULL),size=1)+
     geom_point(fill='lightgray',shape=19,alpha=0.3) +
     geom_segment(aes(xend = PPM, yend = .fitted), col='gray',linetype='12',size=0.5) +
     geom_point(data=subset(fit.ER,cat_phenotypes.vanleeuwen2020.essential),color='purple',fill=NA,shape=21,size=2)+
     geom_line(mapping=aes(y=.fitted),size=1) +
     xlab('Protein abundance (log10 ppm)') + ylab('Mean ER (full seq.)') +theme_clean() 
MR

MR2= ggplot(data=fit.ER, aes(y=.resid,x=PPM)) +
  geom_point(col='lightgray',fill='black',size=2,shape=19) +
  geom_segment(aes(xend = PPM, yend = 0),col='gray',linetype='12',size=0.5) +
  geom_abline(slope=0,intercept = 0,size=1)+
  geom_point(data=subset(fit.ER,cat_phenotypes.vanleeuwen2020.essential),color='purple',fill=NA,shape=21,size=2)+
  geom_segment(data=subset(fit.ER,cat_phenotypes.vanleeuwen2020.essential),aes(xend = PPM, y=0, yend = .resid),col='purple') +
  xlab('Protein abundance (log10 ppm)') + ylab('Residuals (ER)') +theme_clean() 
MR2

# Show most over/under estimated categories
#colnames(fit.ER)[1:25]

ER.residuals = fit.ER %>% 
  pivot_longer( cols= starts_with('cat_'), 
                names_to = c('categories','source','property'), 
                names_pattern="cat_(.+)\\.(.+)\\.(.+)",
                values_to = "has_prop") %>%
  filter(has_prop) %>%
  relocate(SGD,GNAME,PNAME,UNIPROT,ORF,categories,source,property,has_prop) %>%
  arrange(categories,source,property,ORF) %>%
  mutate( total.resid = sum(abs(.resid)) ) %>%
  group_by(categories,source, property) %>% 
  summarise(  N=n(),
              sum.resid = sum(.resid), 
              rel.resid = sum(abs(.resid))/total.resid,
              avg.resid = mean_(.resid), 
              neg.resid = sum(.resid[.resid<0]), 
              pos.resid = sum(.resid[.resid>0])) %>% 
  distinct() %>% 
  filter(N>10) %>%
  arrange(desc(rel.resid))




# res.cat = fit.ER %>%
#   pivot_longer(cols = 22:ncol(fit.ER),names_to = 'filter') %>% 
#   filter(value==T) %>% 

library(ggplot2)
library(ggfittext)
ggplot(beverages, aes(x = beverage, y = proportion, label = ingredient)) +
  #geom_col(position = "dodge") +
  geom_bar_text(position = "dodge", grow = TRUE, reflow = TRUE, place = "left", fullheight = F) +
  coord_flip()

RES.CAT =ER.residuals %>% filter(N > 20 & N < 1500 & abs(sum.resid) > 5)
dim(RES.CAT)

quantile(ER.residuals$sum.resid)
quantile(ER.residuals$avg.resid)

graphics.off()
fig.1 = ggplot(data=RES.CAT, 
               aes(y=reorder(property, -sum.resid),
                   x=sign(sum.resid) * log(abs(sum.resid)),label=property, group=source, fill=categories)) + 
  geom_bar(stat='identity',position='dodge') +
  theme_minimal() +
  facet_wrap(~categories,scales = 'free_y')

plot(fig.1)
ggsave(fig.1,path = "plots/", scale=3, filename = "Ressi_PROPERTIES_1.evo_rate_properties.png")

```

