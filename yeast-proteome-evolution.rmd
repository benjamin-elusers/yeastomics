---
title: "Yeast Proteome Evolution"
date: "`r format(Sys.time(), 'Last Modified: %d-%b-%Y %R %p')`"
subtitle: "Integrating timescales in protein evolution from distant species to populations"
author: "[Benjamin Dubreuil](https://github.com/benjamin-elusers/)"
mail: "benjamin.dubreuil@weizmann.ac.il"
github: "benjamin-elusers"
home: "https://github.com/benjamin-elusers/yeastomics/"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: true
    highlight: tango
#  html_document: 
    code_download: true
    code_folding: hide
    fig_caption: yes
    keep_md: yes
#    toc: yes
    toc_depth: 3
    toc_float:
      toc_collapsed: true
    number_sections: true
    theme: lumen
  editor_options: 
    chunk_output_type: console
---

<!-- Github Logo -->
<a href="https://github.com/benjamin-elusers/yeastomics/" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#69b3a2; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

```{r setup, include=F, echo=F, warnings=F, message=F}
knitr::opts_chunk$set(echo = T, collapse = T, cache.lazy = F,autodep = T)
suppressPackageStartupMessages({
  dep.pkg = c("BiocGenerics","Biobase","S4Vectors","parallel","stats4","IRanges","XVector","hutils","AnnotationDbi")
  gr.pkg = c("ggplot2","gridExtra","ggthemes","ggsci","ggpubr","ggrepel","plotly")
  main.pkg = c("tictoc","tidyverse","Biostrings","hablar")
  library(xfun)
  xfun::pkg_attach2(dep.pkg)
  xfun::pkg_attach2(gr.pkg)
  xfun::pkg_attach2(main.pkg)

  # Load dependencies package (optional) ---------------------------------------
  # library(BiocGenerics)
  # library(Biobase)
  # library(S4Vectors)
  # library(parallel)
  # library(stats4)
  # library(IRanges)
  # library(XVector)
  # library(hutils)
  # library(AnnotationDbi)
  # Load graphical packages ----------------------------------------------------
  # library(ggplot2)
  # library(gridExtra)
  # library(ggthemes)
  # library(ggsci)
  # library(ggpubr)
  # library(ggrepel)
  # library(plotly)
  # Load required packages -----------------------------------------------------
  #library(tictoc)
  #library(tidyverse)
  #library(Biostrings)
  #library(hablar)
  # Load custom locl functions (available via Github repo) ---------------------
  source("src/utils.r")
  source("src/function_annotation.r")
  source("src/function_sequence.r")
  source("src/function_phylogenetic.r")
  source("src/function_analysis.r")
  source("src/function_datalocal.r")
  source("src/function_datapub.r")
  source("src/function_YK11.r")
  source("src/theme_black.r")
})
# turn off annoying messages from dplyr::summarise
options(dplyr.summarise.inform = FALSE)
```


# Reference proteomes {.tabset .tabset-pills}

## SGD

_Saccharomyces Genome Database_

The reference genome sequences of the widely used Baker's yeast are maintained by
tbe [SGD](www.yeastgenome.org), corresponding to the strain **S. cerevisiae S288C**.

The SGD also gather many key information such as:

- genome assembly
- Protein-coding sequence
- gene/protein nomenclature
- biological activity (interaction/regulation/complexes)
- curated annotations and descriptins (gene ontology)
- gene and protein expression
- accurate scientific literature,
- genotype/phenotype experiments
...

```{r sgd}
# YEAST REFERENCE SEQUENCES
## SGD
S288C  = load.sgd.proteome(withORF=T) # Reference SGD protein sequences
S288C.cds = load.sgd.CDS(withORF=T) # Reference coding sequences (CDS)
SGD = load.sgd.features() # main SGD gene/protein features
```

## UniProt

_Universal Protein resource_

[UniProt](www.uniprot.org) provides the most comprehensive resource of protein 
sequence and functional information.
<br>
Most protein features are typically stored on the database called UniProt 
KnowledgeBase (UniProtKB).
<br>
This database is a major hub for many specialized databases and webservers that
helps understand proteins role.
<br>
Their [reference proteome](https://www.uniprot.org/uniprot/?query=proteome:UP000002311)
gather proteins for which expression or proof of physical existence has been shown.

```{r unip}
## UNIPROT
# saveRDS(load.uniprot.features(),"data/uniprot-features.rds") # Takes >250sec for ~6700 ids
UNI.SC = load.uniprot.proteome('yeast') # Reference UniprotKB sequences (Uniref)
UNI = readRDS("data/uniprot-features.rds") %>% # main UNIPROT gene/protein features
        group_by(UNIPROTKB) %>%
        mutate( is_uniref = UNIPROTKB %in% names(UNI.SC), one2one = (n()==1) ) 
```

## YK11

_1,011 Saccharomyces cerevisiae isolates_

The [1002 Yeast Genomes project](http://1002genomes.u-strasbg.fr/) constitutes 
the most comprehensive genomic dataset on a single species of yeast. Ultimately 
provide the most extensive view of the genetic and phenotypic diversity within
this model species to date.
<br>
The project was originally slated to include 1002 strains from diverse global locations,
as well as a variety of ecological sources. A total of 1011 whole genome sequences
have been produced and published in [*J. Peter et al.*, Nature 2018](https://doi.org/10.1038/s41586-018-0030-5).

```{r y1k11}
## 1011 strains
# saveRDS(load.1011.strains(),"data/proteome-1011-strains.rds") # Takes >5mn for 6575 ids
YK11 = readRDS("data/proteome-1011-strains.rds")  # 1011 strains proteomes sequences
strains.info = load.jackson2018.data() # strains info from supp mat of Science paper
```

All strains read were aligned on the reference yeast genome (ATCC 204508 / S288c). 
Therefore, all sequenced ORF should have exactly the same length as the references.

## Statistics

Below we calculate some general statistics on the reference yeast proteome.

```{r ref-id-map}
id_orf=names(S288C)
map_sgd2orf = SGD %>% dplyr::filter(name %in% id_orf) %>% dplyr::select(sgdid,name) 
id_sgd = map_sgd2orf$sgdid

UNI.1 = UNI # Backup of Uniprot features table
UNI   = left_join(UNI,map_sgd2orf, by=c('SGD'='sgdid')) %>% dplyr::rename(ORF=name)

id_uni = names(UNI.SC)
map_uni2sgd = UNI %>% dplyr::filter(UNIPROTKB %in% id_uni & one2one & !is.na(SGD)) %>% dplyr::select(UNIPROTKB,SGD,ORF) 
id_y1k = names(YK11)

n_sgd = length(S288C) %>% as.character()
n_uni = length(UNI.SC) %>% as.character()
n_y1k = length(YK11) %>% as.character()
```

Sequences of both SGD and UNIPROTKB proteomes are quite similar, yet, they don't
share the same number of proteins.
<br>
SGD contains **`r n_sgd`** sequences while UNIPROTKB has **`r n_uni`** sequences.

```{r ref-ali}
uniseq = UNI.SC[map_uni2sgd$UNIPROTKB]
sgdseq = S288C[map_uni2sgd$ORF]
aliref = align.pair.prot(uniseq, sgdseq) # Takes ~20s for 6042 ids
#saveRDS(pairwise.alignment.to.df(aliref),"data/sgduni-aligned-proteome.rds") # Takes ~8mn for 6042 ids
ALI_REF = readRDS("data/sgduni-aligned-proteome.rds")

ALI_STAT = group_by(ALI_REF,s1) %>%
           summarise( not_aligned=sum(!aligned), OL = mean(ol.12), PID = mean(pid.long) )
## OVERALL PROTEOME ALIGNMENT
# 99.93% (+/- 1.44%) identity on average for 6014 proteins
n_aligned = sum(ALI_STAT$PID==100) %>% as.character()
pid_avg = mean(ALI_STAT$PID) %>% round(2) %>% as.character()
pid_sd  = sd(ALI_STAT$PID) %>% round(2) %>% as.character()

## FOR MISALIGNED PROTEINS
n_misaligned = sum(ALI_STAT$PID<100) %>% as.character()
# 85.97% (+/- 16.10%) identity on average for 28 proteins
pid_avg.2 = mean(ALI_STAT$PID[ALI_STAT$not_aligned!=0]) %>% round(2) %>% as.character()
pid_sd.2 = sd(ALI_STAT$PID[ALI_STAT$not_aligned!=0]) %>%  round(2) %>% as.character()
n_unaligned = sum(ALI_STAT$not_aligned) %>% as.character()
```

On average, the mapped SGD/UNIPROT sequences share **`r pid_avg`%** identity **(+/- `r pid_sd`%)**
<br>
**`r n_aligned`** proteins are exactly identical (i.e. 100% identity) between the two proteomes.
<br>

**`r n_misaligned`** proteins contains mismatches/indels for at least **`r n_unaligned`** residues.
<br>
The misaligned proteins share on average **`r pid_avg.2`%** identity  **(+/- `r pid_sd.2`%)**

# Proteome datasets {.tabset .tabset-pills}

## Annnotations

_Gene ontology, SGD description, Uniprot commments_

The protein localizations can be obtained from curated annotations from 
Gene Ontology (GO) and the subcellular locations from Uniprot.

```{r load-annotations}
GO   = get.uniprot.go(id_uni)
CC   = GO %>% dplyr::filter(ONTOLOGY == CC) 
LOC  = get.uniprot.localization(annot = UNI,loc_to_columns = T)
DESC = get.uniprot.sgd(id_uni) 
DESC.UNI = DESC %>% 
            left_join(UNI, by=c('UNIPROT'='UNIPROTKB','ORF'='ORF','SGD'='SGD')) %>%
            dplyr::filter(one2one)
```

## Conservation

_Site-specific evolutionary rates_

[Rate4Site](https://www.tau.ac.il/~itaymay/cp/rate4site.html) is a program for 
detecting conserved amino-acid sites by computing the relative evolutionary rate
for each site in the multiple sequence alignment (MSA).
<br>
For the fungi lineage, we calculated the evolutionary rates of the orthologs 
defined in [*Wapinsky et al.*, Nature 2007](https://www.nature.com/articles/nature06107). 
<br>
For the S. cerevisiae population, we calculated the rate of evolution at 
every site of the 1011 isolates proteomes.This rate is expected to be better than
a non-synonymous SNP frequency. 
<br>
Indeed, the phylogenetic tree of the 1011 strains is taken into account to balance
for SNPs that occur in closely related strains relative to SNPs coming from the 
most recent common ancestor (MRCA).

```{r load-evorate}
WAP.r4s = load.wapinsky2007.data()   # Evolutionary rate for fungi lineage (~20s to load)
#saveRDS(load.rate4site_1011.data(), "data/rate4site-1011-strains.rds") (~3mn to load)
K11.r4s = readRDS("data/rate4site-1011-strains.rds") # Evolutionary rate for 1011 strains 
EVO = load.aligned.data(data.path="data/" ) # Protein dataset with aligned evolutionary rate

FUNGI = WAP.r4s %>%
        group_by(r4s_orf,r4s_size) %>%
        mutate(R4S_norm = R4S_res + abs(min_(R4S_res))) %>%
        summarise(r4s.fungi = mean_(R4S_norm),
                  max_r4s.fungi = max_(R4S_norm)
        )
POP  = K11.r4s %>% dplyr::filter( !is.na(ID) ) %>% 
       group_by(orf,len.s288c) %>%
       summarise(r4s.yk11 = mean_(SCORE),
                max_r4s.yk11 = max_(SCORE)
       )
R4S = left_join(POP,FUNGI, by=c('orf'='r4s_orf', 'len.s288c'='r4s_size'))

R4S.desc = left_join(R4S,DESC.UNI,by=c('orf'='ORF'))
C1 =  spearman(X=R4S.desc$r4s.fungi,Y=R4S.desc$r4s.yk11)
C1$toshow = sprintf("r=%.3f\np=%.1e",C1$estimate,C1$p.value)
F1 = ggplot(R4S.desc) + 
     geom_point(aes(y=r4s.fungi,x=r4s.yk11,text=orf,func=FUNCTION), color='white', fill=NA,,shape=21,size=0.8) + 
     geom_text(data=C1, aes(x=Inf,y=Inf,label=toshow), hjust='inward',vjust='inward',color='white',size=4) +
     xlab("1011 strains evolutionary rate") + ylab('Fungi Evolutionary rate') +
     scale_x_log10() +
     theme_black()
plot(F1)
```

## Expression

Protein expression is taken from 
[*Ho et al.*, Cell Systems, 2018](https://doi.org/10.1016/j.cels.2017.12.004) 
which attempts to unify protein abundance datasets from the 
[Protein Abundance database](www.paxdb.org).
<br>
tRNA adapation index is calculated from the coding sequence (CDS) from SGD as in 
[*Dos Reis et al.*, NAR, 2004](https://doi.org/10.1093/nar/gkh834).

```{r load-expression}
TAI = load.codon.usage(S288C.cds)
PAB = load.ho2018.data()

EXP = left_join(TAI,PAB, by=c('prot'='orf'))
# TAI vs PROT EXP
#F2 = ggplot(EXP)
```

# Yeast SNP {.tabset .tabset-pills}

## SNP from 1011 strains

Using the translated protein sequences from the 1011 isolates proteomes, I have
calculated the frequency of amino acids at every site of each ORF across strains.

```{r snp-proc}
SNP_FREQ=0.05
ref.file = 'data/YK11_REF.rds'
snp.file = 'data/YK11_SNP.rds'
ref.snp.file = 'data/YK11_REF_SNP.rds'
P = tibble( orf=names(YK11), 
            n_strains=lengths(YK11),
            len = sapply(widths(YK11),unique)
)

if( !file.exists(ref.file) ){
  task1="Extract WT amino-acid..."
  cat(task1)
  tic(task1)
  REF = map_df(YK11, get.REF, p=SNP_FREQ)
  saveRDS(REF,ref.file)
  toc()
}else{
  REF = readRDS(ref.file)
}

if( !file.exists(snp.file) ){
  task2="Extract ALT amino-acid..."
  cat(task2)
  tic(task2)
  SNP = map_df(YK11, get.SNP, p=SNP_FREQ)
  saveRDS(SNP,snp.file)
  toc()
}else{
  SNP = readRDS(snp.file)
}
REF_SNP = left_join(REF,SNP,by=c('pos_ref'='pos_alt', 'orf'='orf'))
#saveRDS(REF_SNP,ref.snp.file)
#REF_SNP = readRDS('data/YK11_REF_SNP.rds')

TOTAL_SNP_VAR = nrow(REF_SNP) %>% as.character()
TOTAL_SNP_POS = nrow(REF) %>% as.character()

PROT_SNP = left_join(P,REF_SNP,by=c('orf'='orf'))
snppos = map_df( YK11, count.SNP.bypos, p=SNP_FREQ,nbin=100 )
snpbin = pivot_wider(snppos, id_cols = c('orf','bin.pos'), names_from=bin.pos, names_prefix = "b", values_from = n_snp)
```

Some sites are ambiguous between strains, meaning that some strains may have an
alternative amino-acid at that position.
<br>

To get the SNPs, I considered the frequency of all variants must be above a 
cutoff of **`r as.character(100*SNP_FREQ)`%**. 

Since, I am looking at amino-acid frequencies we can only consider non-synonymous mutations.
<br>
Indels are not incorporated in the strains sequences.

A total of **`r TOTAL_SNP_VAR`** variants have been identified spread over
**`r TOTAL_SNP_POS`** positions of the proteome.

```{r snp-plot}
n_snp= PROT_SNP %>% 
        group_by(orf) %>%
        summarize( nsnp = n_distinct(pos_ref), len=mean(len)) %>%
        left_join(DESC,by=c('orf'='ORF'))
# Histogram for number of SNP
F3 = ggplot(n_snp) + 
      geom_histogram(aes(nsnp),binwidth = 1, fill='white',color='black') +
      theme_black()
ggplotly(F3)

# SNP count vs Protein Length
F4 = ggplot(n_snp) + 
     geom_point(aes(y=nsnp,x=len,text=orf,func=FUNCTION), color='white', fill=NA,,shape=21,size=0.8) + 
     xlab("Protein Length (AA)") + ylab('SNP count') +
     theme_black()
ggplotly(F4)

# SNP count along protein length
snp_by_pos = snppos %>% 
              group_by(bin.pos) %>% 
              summarize( avgSNP=mean(n_snp), sdSNP=sd(n_snp), maxSNP=max(n_snp))

F5 = ggplot(snp_by_pos,aes(x=bin.pos,y=avgSNP)) +
      #geom_point() + 
      geom_line(col='white') + 
      geom_line(aes(y=maxSNP),col='red') + 
      geom_linerange(aes(ymin=avgSNP-sdSNP,ymax=avgSNP+sdSNP),col='white') +
      geom_vline(xintercept=seq(5,95,by=5),size=0.1,linetype='dashed') +
      ylab('SNP count') + xlab('Sequence position (%)') +
      theme_black() 
ggplotly(F5)
      
#p = grid.arrange(p0,p1,ncol=2)
```

Similarly, I calculated the number of "early-STOP" codons,
*i.e.* STOP codons which occur before the last amino acid.

```{r stop-plot}
```

```{r snp-exp}
SNP.PROT = left_join(n_snp, EXP , by=c('orf'='prot')) %>% # Add expression data 
  left_join(R4S, by=c('orf'='orf'))# %>% # Add conservation data 
  #left_join(DESC.UNI,by=c('orf'='ORF')) # Add annotation data
  
# SNP count vs Protein Length
F6 = ggplot(SNP.PROT) + 
     geom_point(aes(y=nsnp,x=r4s.fungi,text=orf,func=FUNCTION), color='white', fill=NA,,shape=21,size=0.8) + 
     xlab("Fungi Evolutionary rate") + ylab('SNP count') +
     scale_y_continuous(trans='log2') +
     theme_black()
F7 = ggplot(SNP.PROT) + 
     geom_point(aes(y=nsnp,x=r4s.yk11,text=orf,func=FUNCTION), color='white', fill=NA,,shape=21,size=0.8) + 
     xlab("1011 strains evolutionary rate") + ylab('SNP count') +
     scale_x_log10() + scale_y_continuous(trans='log2') +
     theme_black()
ggplotly(F6)
ggplotly(F7)
```



## Variant viewer (Testing... in progress)
```{r snp-viewer, echo = FALSE}
library(shiny)
#shinyAppDir(
#  system.file("shiny/06_tabsets", package="shiny"),
#  options = list(width = "100%", height = 700)
#)
```

# References

Jackson et al.: 
[***Genome evolution across 1,011 Saccharomyces cerevisiae isolates***](https://doi.org/10.1038/s41586-018-0030-5)
<br>
Rate4site: 
[***Comparison of site-specific rate-inference methods: Bayesian methods are superior***](https://doi.org/10.1093/molbev/msh194)
<br>
Wapinski et al.: [***Natural history and evolutionary principles of gene duplication in fungi***](https://www.nature.com/articles/nature06107)
<br>
Ho et al.: [***Unification of Protein Abundance Datasets Yields a Quantitative Saccharomyces cerevisiae Proteome***](https://doi.org/10.1016/j.cels.2017.12.004)
<br>
Dos Reis et al.: [***Solving the riddle of codon usage preferences: a test for translational selection***](https://doi.org/10.1093/nar/gkh834)

# Session Info {-}

```{r session-info}
sessionInfo()
```
